<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miei Eventi Sportivi</title>
    <style>
        body { font-family: sans-serif; background-color: #121212; color: white; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        h1 { text-align: center; color: #0088cc; }
        .day-section { margin-bottom: 30px; border-top: 1px solid #333; padding-top: 10px; }
        .day-title { font-size: 1.2em; font-weight: bold; color: #0088cc; margin-bottom: 10px; text-transform: uppercase; }
        .event-card { background: #1e1e1e; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #0088cc; }
        .event-card.special { border-left-color: #ff4444; background: #2c1a1a; }
        .time { font-weight: bold; color: #0088cc; font-size: 1.1em; }
        .cat { font-size: 0.8em; color: #aaa; display: block; margin-bottom: 5px; }
        .title { font-size: 1em; font-weight: bold; display: block; }
        .status { text-align: center; font-size: 0.9em; color: #888; margin-bottom: 20px; }
        button { display: block; width: 100%; padding: 10px; background: #0088cc; border: none; color: white; border-radius: 5px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèÜ I Miei Eventi</h1>
    <div class="status" id="status">Caricamento in corso...</div>
    <button onclick="loadFromTelegram()">Aggiorna Ora</button>
    <div id="app"></div>
</div>

<script>
// Proxy per leggere Telegram senza blocchi
const PROXY = "https://api.allorigins.win/get?url=";
const TELEGRAM_URL = "https://t.me/s/CampioneIT";

// FILTRI: Qui puoi aggiungere o togliere quello che vuoi seguire
const MIEI_INTERESSI = /Serie A|Champions|Europa League|Conference|Monza|Catanzaro|Reggina|Sinner|Musetti|Berrettini|Paolini|Darderi|Formula 1|F1|MotoGP|Vero Volley|Brignone|Goggia|Diretta Goal/i;

async function loadFromTelegram() {
    const status = document.getElementById('status');
    const app = document.getElementById('app');
    status.textContent = "‚è≥ Recupero messaggi da Telegram...";
    
    try {
        const response = await fetch(PROXY + encodeURIComponent(TELEGRAM_URL));
        const data = await response.json();
        const html = data.contents;
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        // Prende i messaggi dal pi√π recente
        const messages = Array.from(doc.querySelectorAll('.tgme_widget_message_text')).reverse();
        
        const results = { oggi: [], ieri: [], domani: [] };

        messages.forEach(msg => {
            const text = msg.innerText;
            if (text.includes("Sport in TV oggi")) {
                const lines = text.split('\n');
                const dataTesto = lines[1] || ""; // La seconda riga di solito ha la data
                const dayType = identificaGiorno(dataTesto);
                
                if (dayType && results[dayType].length === 0) {
                    results[dayType] = estraiEventi(text);
                }
            }
        });

        mostraEventi(results);
        status.textContent = "‚úÖ Ultimo aggiornamento: " + new Date().toLocaleTimeString();
    } catch (e) {
        status.textContent = "‚ùå Errore di caricamento. Riprova.";
        console.error(e);
    }
}

function identificaGiorno(testo) {
    const t = testo.toLowerCase();
    const oggi = new Date().getDate();
    // Cerca il numero del giorno nel testo (es: "26 gennaio")
    const match = t.match(/(\d{1,2})/);
    if (!match) return null;
    
    const giornoPost = parseInt(match[1]);
    if (giornoPost === oggi) return "oggi";
    if (giornoPost === oggi - 1) return "ieri";
    if (giornoPost === oggi + 1) return "domani";
    return null;
}

function estraiEventi(testo) {
    const lines = testo.split('\n');
    let categoriaCorrente = "Sport";
    const eventiTrovati = [];

    lines.forEach(line => {
        const l = line.trim();
        // Se la riga √® una categoria (ha un'emoji all'inizio e non √® un orario)
        if (l.match(/^[^\d\s]{1,2}\s+[A-Z]/)) {
            categoriaCorrente = l.replace(/[^\w\s‚Äî]/g, '').trim();
        }
        
        // Se la riga √® un evento (inizia con orario 12:30 o 12.30)
        const matchOrario = l.match(/^(\d{2}[:.]\d{2})\s*[‚Äî‚Äì-]\s*(.*)/);
        if (matchOrario) {
            const info = matchOrario[2];
            // Applica il filtro dei tuoi interessi
            if (MIEI_INTERESSI.test(info) || MIEI_INTERESSI.test(categoriaCorrente)) {
                eventiTrovati.push({
                    ora: matchOrario[1],
                    cat: categoriaCorrente,
                    titolo: info,
                    speciale: /Diretta Goal/i.test(info)
                });
            }
        }
    });
    return eventiTrovati;
}

function mostraEventi(dati) {
    const app = document.getElementById('app');
    app.innerHTML = "";
    
    ["ieri", "oggi", "domani"].forEach(giorno => {
        const eventi = dati[giorno];
        if (eventi.length === 0 && giorno !== "oggi") return;

        const html = `
            <div class="day-section">
                <div class="day-title">${giorno}</div>
                ${eventi.length === 0 ? '<div style="color:#666">Nessun evento trovato</div>' : 
                    eventi.map(ev => `
                    <div class="event-card ${ev.speciale ? 'special' : ''}">
                        <span class="cat">${ev.cat}</span>
                        <span class="time">${ev.ora}</span>
                        <span class="title">${ev.titolo}</span>
                    </div>
                `).join('')}
            </div>
        `;
        app.innerHTML += html;
    });
}

// Avvia al caricamento
window.onload = loadFromTelegram;
</script>

</body>
</html>
