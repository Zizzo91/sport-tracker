<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Miei Eventi Sportivi</title>
  <style>
    :root {
      --bg: #0f172a; --card: #1e293b; --text: #f1f5f9;
      --accent: #38bdf8; --danger: #ef4444; --success: #22c55e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg); color: var(--text);
      line-height: 1.5; padding: 20px;
    }
    .container { max-width: 800px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 30px; }
    h1 { font-size: 2rem; margin-bottom: 10px; color: var(--accent); }
    
    .controls {
      display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;
    }
    button {
      background: var(--accent); color: var(--bg); border: none;
      padding: 10px 20px; border-radius: 8px; font-weight: bold;
      cursor: pointer; transition: opacity 0.2s;
    }
    button:disabled { opacity: 0.5; }

    .status { text-align: center; font-size: 0.9rem; margin-bottom: 20px; color: #94a3b8; }

    .day-section { margin-bottom: 30px; }
    .day-title {
      font-size: 1.25rem; font-weight: bold; margin-bottom: 15px;
      padding-bottom: 5px; border-bottom: 2px solid var(--accent);
      text-transform: uppercase; letter-spacing: 1px;
    }

    .event-card {
      background: var(--card); border-radius: 12px; padding: 16px;
      margin-bottom: 12px; border-left: 4px solid var(--accent);
      transition: transform 0.2s; cursor: pointer;
    }
    .event-card:hover { transform: translateX(5px); }
    .event-card.diretta-goal { border-left-color: var(--danger); background: #450a0a; }
    
    .event-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .event-time { font-weight: 800; color: var(--accent); font-size: 1.1rem; }
    .event-cat { font-size: 0.8rem; background: rgba(56, 189, 248, 0.2); padding: 2px 8px; border-radius: 4px; }
    .diretta-goal .event-time { color: var(--danger); }

    .event-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 6px; }
    .event-channel { font-size: 0.9rem; color: #94a3b8; font-style: italic; }

    .empty { text-align: center; padding: 20px; color: #64748b; }
    .reggina-note { color: #f87171; font-weight: bold; margin-top: 5px; display: block; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>I Miei Eventi Sportivi</h1>
    <p>Filtro automatico da OA Sport (Ieri/Oggi/Domani)</p>
  </header>

  <div class="controls">
    <button id="refreshBtn">Aggiorna Dati</button>
  </div>
  <div class="status" id="status">Inizializzazione...</div>

  <div id="app"></div>
</div>

<script>
const PROXY = "https://api.allorigins.win/raw?url=";
const TAG_URL = "https://www.oasport.it/tag/sport-in-tv-oggi/";

// CONFIGURAZIONE FILTRI
const ITALIAN_TEAMS = "Inter|Milan|Juventus|Napoli|Roma|Lazio|Atalanta|Fiorentina|Bologna";
const TENNIS_PLAYERS = "Sinner|Musetti|Berrettini|Paolini|Darderi|Arnaldi|Sonego|Cobolli|Cocciaretto|Errani|Bronzetti|Vavassori";

const FILTERS = [
  { name: "Serie A", regex: /Serie A/i },
  { name: "Champions League", regex: new RegExp(`Champions League.*(${ITALIAN_TEAMS})|(${ITALIAN_TEAMS}).*Champions League`, "i") },
  { name: "Europa League", regex: new RegExp(`Europa League.*(${ITALIAN_TEAMS})|(${ITALIAN_TEAMS}).*Europa League`, "i") },
  { name: "Conference League", regex: new RegExp(`Conference League.*(${ITALIAN_TEAMS})|(${ITALIAN_TEAMS}).*Conference League`, "i") },
  { name: "Serie B (Monza/CZ)", regex: /Serie B.*(Monza|Catanzaro)|(Monza|Catanzaro).*Serie B/i },
  { name: "Serie D (Reggina)", regex: /Reggina|Serie D/i },
  { name: "Tennis ITA", regex: new RegExp(TENNIS_PLAYERS, "i") },
  { name: "F1", regex: /Formula 1|F1/i },
  { name: "MotoGP", regex: /MotoGP/i },
  { name: "Volley Monza", regex: /Vero Volley|Monza.*Volley/i },
  { name: "Sci (Brignone/Goggia)", regex: /Brignone|Sofia Goggia/i },
  { name: "DIRETTA GOAL", regex: /Diretta Goal/i, isSpecial: true }
];

async function loadData() {
  const btn = document.getElementById('refreshBtn');
  const status = document.getElementById('status');
  btn.disabled = true;
  status.textContent = "Recupero lista articoli...";

  try {
    const tagHtml = await fetch(PROXY + encodeURIComponent(TAG_URL)).then(r => r.text());
    const doc = new DOMParser().parseFromString(tagHtml, 'text/html');
    const links = Array.from(doc.querySelectorAll('h2 a, h3 a'))
      .map(a => ({ title: a.innerText, url: a.href }))
      .filter(l => l.title.toLowerCase().includes("sport in tv oggi"));

    const results = { ieri: [], oggi: [], domani: [] };
    
    // Analizziamo i primi 5 articoli per trovare ieri, oggi e domani
    for (const link of links.slice(0, 5)) {
      const dateType = getDayType(link.title);
      if (!dateType) continue;

      status.textContent = `Analisi eventi di ${dateType}...`;
      const artHtml = await fetch(PROXY + encodeURIComponent(link.url)).then(r => r.text());
      const artDoc = new DOMParser().parseFromString(artHtml, 'text/html');
      const content = artDoc.querySelector('.mvp-content-main, #mvp-content-main') || artDoc.body;
      
      const events = parseEvents(content.innerText);
      results[dateType] = events;
    }

    render(results);
    status.textContent = "Ultimo aggiornamento: " + new Date().toLocaleTimeString();
  } catch (e) {
    console.error(e);
    status.textContent = "Errore nel caricamento. Riprova.";
  } finally {
    btn.disabled = false;
  }
}

function getDayType(title) {
  const t = title.toLowerCase();
  const now = new Date();
  const months = ["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"];
  
  const match = t.match(/(\d{1,2})\s+([a-z]+)/);
  if (!match) return null;

  const day = parseInt(match[1]);
  const month = months.indexOf(match[2]);
  if (month === -1) return null;

  const artDate = new Date(now.getFullYear(), month, day);
  const diff = Math.round((artDate - new Date(now.getFullYear(), now.getMonth(), now.getDate())) / 86400000);

  if (diff === 0) return "oggi";
  if (diff === -1) return "ieri";
  if (diff === 1) return "domani";
  return null;
}

function parseEvents(text) {
  // Cerchiamo righe che iniziano con un orario (es. 20.45)
  const lines = text.split('\n');
  const found = [];
  
  lines.forEach(line => {
    const timeMatch = line.match(/^(\d{1,2}[.:]\d{2})\s+(.*)/);
    if (timeMatch) {
      const time = timeMatch[1];
      const info = timeMatch[2];
      
      for (const filter of FILTERS) {
        if (filter.regex.test(info)) {
          found.push({
            time,
            title: info.split('–')[0].trim(),
            channel: info.split('–')[1]?.trim() || "Vedi articolo",
            category: filter.name,
            isSpecial: filter.isSpecial
          });
          break; 
        }
      }
    }
  });
  return found;
}

function render(data) {
  const container = document.getElementById('app');
  container.innerHTML = "";

  ["ieri", "oggi", "domani"].forEach(day => {
    const section = document.createElement('div');
    section.className = "day-section";
    
    const title = document.createElement('div');
    title.className = "day-title";
    title.textContent = day;
    section.appendChild(title);

    if (data[day].length === 0) {
      section.innerHTML += `<div class="empty">Nessun evento salvato per ${day}</div>`;
    } else {
      data[day].forEach(ev => {
        const isReggina = ev.title.toLowerCase().includes("reggina");
        const card = document.createElement('div');
        card.className = `event-card ${ev.isSpecial ? 'diretta-goal' : ''}`;
        card.innerHTML = `
          <div class="event-header">
            <span class="event-time">${ev.time}</span>
            <span class="event-cat">${ev.category}</span>
          </div>
          <div class="event-title">${ev.title}</div>
          <div class="event-channel">${ev.channel}</div>
          ${isReggina ? '<span class="reggina-note">Nota: Trasferte spesso su ReggioTV</span>' : ''}
        `;
        section.appendChild(card);
      });
    }
    container.appendChild(section);
  });
}

document.getElementById('refreshBtn').addEventListener('click', loadData);
window.onload = loadData;
</script>

</body>
</html>
