<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miei Eventi Sportivi</title>
  <style>
    :root {
      --bg: #0f172a; --card: #1e293b; --text: #f1f5f9;
      --accent: #38bdf8; --danger: #ef4444; --success: #22c55e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg); color: var(--text);
      line-height: 1.5; padding: 20px;
    }
    .container { max-width: 800px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 20px; }
    h1 { font-size: 1.8rem; color: var(--accent); margin-bottom: 5px; }
    
    .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
    button {
      background: var(--accent); color: var(--bg); border: none;
      padding: 12px 24px; border-radius: 8px; font-weight: bold;
      cursor: pointer; font-size: 1rem;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .status { text-align: center; font-size: 0.85rem; margin-bottom: 20px; color: #94a3b8; min-height: 1.2rem; }

    .day-section { margin-bottom: 30px; }
    .day-title {
      font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;
      padding-bottom: 5px; border-bottom: 2px solid var(--accent);
      text-transform: uppercase; color: var(--accent);
    }

    .event-card {
      background: var(--card); border-radius: 10px; padding: 15px;
      margin-bottom: 10px; border-left: 4px solid var(--accent);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .event-card.diretta-goal { border-left-color: var(--danger); background: #450a0a; }
    
    .event-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .event-time { font-weight: 800; color: var(--accent); font-size: 1.1rem; }
    .event-cat { font-size: 0.75rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; color: #cbd5e1; }
    .diretta-goal .event-time { color: var(--danger); }

    .event-title { font-weight: bold; font-size: 1.05rem; margin-bottom: 4px; }
    .event-channel { font-size: 0.9rem; color: #94a3b8; }

    .empty { text-align: center; padding: 20px; color: #64748b; font-style: italic; background: rgba(255,255,255,0.03); border-radius: 10px; }
    .reggina-note { color: #f87171; font-weight: bold; font-size: 0.85rem; margin-top: 5px; display: block; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Miei Eventi Sportivi</h1>
  </header>

  <div class="controls">
    <button id="refreshBtn">Aggiorna Eventi</button>
  </div>
  <div class="status" id="status">Clicca su Aggiorna per iniziare</div>

  <div id="app"></div>
</div>

<script>
// Usiamo un proxy CORS più affidabile o fallback
const PROXY = "https://api.allorigins.win/raw?url=";
const TAG_URL = "https://www.oasport.it/tag/sport-in-tv-oggi/";

const ITALIAN_TEAMS = "Inter|Milan|Juventus|Napoli|Roma|Lazio|Atalanta|Fiorentina|Bologna|Monza|Catanzaro|Reggina";
const TENNIS_PLAYERS = "Sinner|Musetti|Berrettini|Paolini|Darderi|Arnaldi|Sonego|Cobolli|Cocciaretto|Errani|Bronzetti|Vavassori|Bolelli";

const FILTERS = [
  { name: "DIRETTA GOAL", regex: /Diretta Goal/i, special: true },
  { name: "Serie A", regex: /Serie A/i },
  { name: "Champions/Europa/Conf", regex: new RegExp(`(Champions|Europa|Conference) League.*(${ITALIAN_TEAMS})|(${ITALIAN_TEAMS}).*(Champions|Europa|Conference)`, "i") },
  { name: "Monza/Catanzaro", regex: /Monza|Catanzaro/i },
  { name: "Reggina", regex: /Reggina/i },
  { name: "Tennis ITA", regex: new RegExp(TENNIS_PLAYERS, "i") },
  { name: "F1/MotoGP", regex: /Formula 1|F1|MotoGP/i },
  { name: "Volley Monza", regex: /Vero Volley|Monza.*Volley/i },
  { name: "Sci ITA", regex: /Brignone|Sofia Goggia/i }
];

async function loadData() {
  const btn = document.getElementById('refreshBtn');
  const status = document.getElementById('status');
  const app = document.getElementById('app');
  
  btn.disabled = true;
  status.textContent = "Caricamento lista articoli...";
  app.innerHTML = "";

  try {
    const tagHtml = await fetch(PROXY + encodeURIComponent(TAG_URL)).then(r => r.text());
    const doc = new DOMParser().parseFromString(tagHtml, 'text/html');
    
    // Cerchiamo i link in modo più aggressivo
    const links = Array.from(doc.querySelectorAll('article a, h2 a, h3 a'))
      .map(a => ({ title: a.innerText.trim(), url: a.href }))
      .filter(l => l.title.toLowerCase().includes("sport in tv oggi") && l.url.includes("oasport.it"));

    // Rimuovi duplicati
    const uniqueLinks = Array.from(new Map(links.map(item => [item.url, item])).values());
    
    if (uniqueLinks.length === 0) {
      status.textContent = "Nessun articolo trovato. OA Sport potrebbe aver cambiato layout.";
      return;
    }

    const results = { ieri: [], oggi: [], domani: [] };
    
    for (const link of uniqueLinks.slice(0, 4)) {
      const dateType = getDayType(link.title);
      if (!dateType) continue;

      status.textContent = `Leggo eventi di ${dateType.toUpperCase()}...`;
      const artHtml = await fetch(PROXY + encodeURIComponent(link.url)).then(r => r.text());
      const artDoc = new DOMParser().parseFromString(artHtml, 'text/html');
      
      // Prendiamo tutto il testo dell'articolo per non sbagliare selettore
      const fullText = artDoc.body.innerText;
      const events = parseEvents(fullText);
      results[dateType] = results[dateType].concat(events);
    }

    render(results);
    status.textContent = "Aggiornato alle " + new Date().toLocaleTimeString();
  } catch (e) {
    status.textContent = "Errore di connessione. Riprova tra poco.";
    console.error(e);
  } finally {
    btn.disabled = false;
  }
}

function getDayType(title) {
  const t = title.toLowerCase();
  const months = ["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"];
  
  const match = t.match(/(\d{1,2})\s+([a-z]+)/);
  if (!match) return null;

  const day = parseInt(match[1]);
  const month = months.indexOf(match[2]);
  if (month === -1) return null;

  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const artDate = new Date(now.getFullYear(), month, day);
  
  const diff = Math.round((artDate - today) / 86400000);

  if (diff === 0) return "oggi";
  if (diff === -1) return "ieri";
  if (diff === 1) return "domani";
  return null;
}

function parseEvents(text) {
  const lines = text.split('\n');
  const found = [];
  // Regex: cerca "HH.MM" o "HH:MM" all'inizio della riga
  const timeRegex = /^(\d{1,2}[.:]\d{2})\s+/;

  lines.forEach(line => {
    const trimmed = line.trim();
    if (timeRegex.test(trimmed)) {
      const match = trimmed.match(timeRegex);
      const time = match[1];
      const content = trimmed.replace(time, "").trim();
      
      for (const filter of FILTERS) {
        if (filter.regex.test(content)) {
          // Evita duplicati nella stessa giornata
          if (!found.some(f => f.time === time && f.title.substring(0,10) === content.substring(0,10))) {
            found.push({
              time,
              title: content.split('–')[0].split('–')[0].replace(/^[:\s-]+/, "").trim(),
              channel: content.includes('–') ? content.split('–')[1].trim() : "Vedi dettagli nell'articolo",
              category: filter.name,
              special: filter.special
            });
          }
          break;
        }
      }
    }
  });
  return found;
}

function render(data) {
  const container = document.getElementById('app');
  container.innerHTML = "";

  ["ieri", "oggi", "domani"].forEach(day => {
    const section = document.createElement('div');
    section.className = "day-section";
    section.innerHTML = `<div class="day-title">${day}</div>`;

    if (!data[day] || data[day].length === 0) {
      section.innerHTML += `<div class="empty">Nessun evento trovato per i tuoi filtri</div>`;
    } else {
      // Ordina per orario
      data[day].sort((a,b) => a.time.localeCompare(b.time)).forEach(ev => {
        const card = document.createElement('div');
        card.className = `event-card ${ev.special ? 'diretta-goal' : ''}`;
        const isReggina = ev.title.toLowerCase().includes("reggina");
        
        card.innerHTML = `
          <div class="event-header">
            <span class="event-time">${ev.time}</span>
            <span class="event-cat">${ev.category}</span>
          </div>
          <div class="event-title">${ev.title}</div>
          <div class="event-channel">${ev.channel}</div>
          ${isReggina ? '<span class="reggina-note">Nota: Trasferte spesso su ReggioTV</span>' : ''}
        `;
        section.appendChild(card);
      });
    }
    container.appendChild(section);
  });
}

document.getElementById('refreshBtn').addEventListener('click', loadData);
// Caricamento automatico all'avvio
window.onload = loadData;
</script>

</body>
</html>
